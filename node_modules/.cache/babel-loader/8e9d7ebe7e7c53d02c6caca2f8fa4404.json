{"ast":null,"code":"import _slicedToArray from\"/home/iivanova/Desktop/UBC_2021_2022/CPSC547_information_visualization/project/explorify/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useRef,useState}from\"react\";import*as d3 from\"d3\";import{comparator,groupBy,msToTime}from\"./helpers\";import{updateBar}from\"./D3BarChart\";import{jsx as _jsx}from\"react/jsx-runtime\";var D3CalendarHeatmap=function D3CalendarHeatmap(){var data=require(\"./data/StreamingHistoryD.json\");var calendarHeatmap=useRef();var rawData=data.map(function(elem){var entry={};entry.date=elem.endTime.split(\" \")[0];entry.msPlayed=elem.msPlayed;entry.artistName=elem.artistName;return entry;});var filteredData=Object.values(groupBy(rawData,\"date\"));var streamingData=filteredData.map(function(day){var date=day[0][\"date\"];day=day.reduce(function(prev,cur){prev.msPlayed=prev.msPlayed+cur.msPlayed;prev.artists[cur.artistName]=(prev.artists[cur.artistName]||0)+cur.msPlayed;return prev;},{\"msPlayed\":0,\"artists\":{}});day.date=date;return day;});streamingData=streamingData.map(function(entry){var artists=Object.keys(entry.artists).map(function(artist){return[artist,entry.artists[artist]];});entry.artists=artists.sort(comparator).concat(Array(19).fill([\" \",0])).slice(0,20);return entry;});var allArtists=rawData.reduce(function(prev,cur){prev[cur.artistName]=(prev[cur.artistName]||0)+cur.msPlayed;return prev;},{});allArtists=Object.keys(allArtists).map(function(artist){return[artist,allArtists[artist]];});var top20Artists=allArtists.sort(comparator).slice(0,20);var _useState=useState(top20Artists),_useState2=_slicedToArray(_useState,2),datasetOnClick=_useState2[0],changeDataset=_useState2[1];var weeksInMonth=function weeksInMonth(month){var m=d3.timeMonth.floor(month);return d3.timeWeeks(d3.timeWeek.floor(m),d3.timeMonth.offset(m,1)).length;};var minDate=new Date(streamingData[0].date);var maxDate=new Date(streamingData[streamingData.length-1].date);useEffect(function(){var weeksInMonth=function weeksInMonth(month){var m=d3.timeMonth.floor(month);return d3.timeWeeks(d3.timeWeek.floor(m),d3.timeMonth.offset(m,1)).length;};var cellMargin=1,cellSize=20;var day=d3.timeFormat(\"%w\"),week=d3.timeFormat(\"%U\"),format=d3.timeFormat(\"%Y-%m-%d\"),titleFormat=d3.utcFormat(\"%a, %d-%b\"),monthName=d3.timeFormat(\"%B\"),months=d3.timeMonth.range(d3.timeMonth.floor(minDate),maxDate);var svg=d3.select(calendarHeatmap.current).selectAll(\"svg\").data(months).enter().append(\"svg\").attr(\"class\",\"month\").attr(\"height\",cellSize*7+cellMargin*8+20)// the 20 is for the month labels\n.attr(\"width\",function(d){var columns=weeksInMonth(d);return cellSize*columns+cellMargin*(columns+1);}).append(\"g\");svg.append(\"text\").attr(\"class\",\"month-name\").attr(\"y\",cellSize*7+cellMargin*8+15).attr(\"x\",function(d){var columns=weeksInMonth(d);return(cellSize*columns+cellMargin*(columns+1))/2;}).attr(\"text-anchor\",\"middle\").text(function(d){return monthName(d);});var div=d3.select(\"body\").append(\"div\").attr(\"class\",\"toolTip\");var rect=svg.selectAll(\"rect.day\").data(function(d,i){return d3.timeDays(d,new Date(d.getFullYear(),d.getMonth()+1,1));}).enter().append(\"rect\").attr(\"class\",\"day\").attr(\"width\",cellSize).attr(\"height\",cellSize).attr(\"rx\",3).attr(\"ry\",3)// rounded corners\n.attr(\"fill\",'#eaeaea')// default light grey fill\n.attr(\"y\",function(d){return day(d)*cellSize+day(d)*cellMargin+cellMargin;}).attr(\"x\",function(d){return(week(d)-week(new Date(d.getFullYear(),d.getMonth(),1)))*cellSize+(week(d)-week(new Date(d.getFullYear(),d.getMonth(),1)))*cellMargin+cellMargin;});var lookup=new Map(streamingData.map(function(entry){return[entry.date,[entry.msPlayed,entry.artists]];}));rect.on(\"mouseover\",function(event,d){var msTime=0;if(lookup.has(d))msTime=lookup.get(d)[0];d3.select(this).classed('hover',true);div.style(\"left\",event.pageX+10+\"px\");div.style(\"top\",event.pageY-25+\"px\");div.style(\"display\",\"inline-block\");div.html(d+\"<br>\"+msToTime(msTime));}).on(\"mouseout\",function(event,d){d3.select(this).classed('hover',false);div.style(\"display\",\"none\");}).on(\"click\",function(event,d){if(!d3.select(this).classed(\"selected\")){d3.selectAll(\".day\").classed(\"selected\",false);d3.select(this).classed('hover',true);d3.select(this).classed(\"selected\",true);if(lookup.has(d))updateBar(lookup.get(d)[1]);}else{d3.select(this).classed('hover',false);d3.select(this).classed(\"selected\",false);updateBar(top20Artists);}}).datum(format);rect.append(\"title\").text(function(d){return titleFormat(new Date(d));});var scale=d3.scaleSequentialSqrt().domain(d3.extent(streamingData,function(d){return parseInt(d.msPlayed);})).range([0.05,1]);rect.style(\"fill\",function(d){var color=function color(d){if(lookup.get(d))return scale(lookup.get(d)[0]);else return scale(0);};return d3.interpolateBlues(color(d));});});return/*#__PURE__*/_jsx(\"div\",{id:\"calendar-heatmap\",ref:calendarHeatmap});};export default D3CalendarHeatmap;","map":{"version":3,"sources":["/home/iivanova/Desktop/UBC_2021_2022/CPSC547_information_visualization/project/explorify/src/D3CalendarHeatmap.js"],"names":["React","useEffect","useRef","useState","d3","comparator","groupBy","msToTime","updateBar","D3CalendarHeatmap","data","require","calendarHeatmap","rawData","map","elem","entry","date","endTime","split","msPlayed","artistName","filteredData","Object","values","streamingData","day","reduce","prev","cur","artists","keys","artist","sort","concat","Array","fill","slice","allArtists","top20Artists","datasetOnClick","changeDataset","weeksInMonth","month","m","timeMonth","floor","timeWeeks","timeWeek","offset","length","minDate","Date","maxDate","cellMargin","cellSize","timeFormat","week","format","titleFormat","utcFormat","monthName","months","range","svg","select","current","selectAll","enter","append","attr","d","columns","text","div","rect","i","timeDays","getFullYear","getMonth","lookup","Map","on","event","msTime","has","get","classed","style","pageX","pageY","html","datum","scale","scaleSequentialSqrt","domain","extent","parseInt","color","interpolateBlues"],"mappings":"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","sourcesContent":["import React, {useEffect, useRef, useState} from \"react\";\nimport * as d3 from \"d3\";\nimport {comparator, groupBy, msToTime} from \"./helpers\";\nimport { updateBar } from \"./D3BarChart\";\n\nconst D3CalendarHeatmap = () => {\n    const data = require(\"./data/StreamingHistoryD.json\");\n    const calendarHeatmap = useRef()\n    const rawData = data.map(function (elem) {\n        let entry = {}\n        entry.date = elem.endTime.split(\" \")[0];\n        entry.msPlayed = elem.msPlayed;\n        entry.artistName = elem.artistName;\n        return entry;\n    });\n\n\n    let filteredData = Object.values(groupBy(rawData, \"date\"));\n\n    let streamingData = filteredData.map(function (day) {\n        let date = day[0][\"date\"];\n        day = day.reduce(function (prev, cur) {\n            prev.msPlayed = prev.msPlayed + cur.msPlayed;\n            prev.artists[cur.artistName] = (prev.artists[cur.artistName] || 0) + cur.msPlayed;\n            return prev;\n        }, {\"msPlayed\": 0, \"artists\": {}});\n        day.date = date;\n        return day;\n    });\n\n    streamingData = streamingData.map(function (entry) {\n        let artists = Object.keys(entry.artists).map(function (artist) {\n            return [artist, entry.artists[artist]];\n        });\n        entry.artists = (artists.sort(comparator).concat(Array(19).fill([\" \", 0]))).slice(0, 20)\n        return entry\n    })\n\n    let allArtists = rawData.reduce(function (prev, cur) {\n        prev[cur.artistName] = (prev[cur.artistName] || 0) + cur.msPlayed;\n        return prev;\n    }, {})\n\n    allArtists = Object.keys(allArtists).map(function (artist) {\n        return [artist, allArtists[artist]];\n    });\n\n    const top20Artists = allArtists.sort(comparator).slice(0, 20)\n    const [datasetOnClick, changeDataset] = useState(top20Artists)\n\n    const weeksInMonth = function(month){\n        let m = d3.timeMonth.floor(month)\n        return d3.timeWeeks(d3.timeWeek.floor(m), d3.timeMonth.offset(m,1)).length;\n    }\n\n    const minDate = new Date(streamingData[0].date)\n    const maxDate = new Date(streamingData[streamingData.length - 1].date)\n\n    useEffect(() => {\n        let weeksInMonth = function(month){\n            let m = d3.timeMonth.floor(month)\n            return d3.timeWeeks(d3.timeWeek.floor(m), d3.timeMonth.offset(m,1)).length;\n        }\n\n\n        const cellMargin = 1,\n            cellSize = 20;\n\n        let day = d3.timeFormat(\"%w\"),\n            week = d3.timeFormat(\"%U\"),\n            format = d3.timeFormat(\"%Y-%m-%d\"),\n            titleFormat = d3.utcFormat(\"%a, %d-%b\"),\n            monthName = d3.timeFormat(\"%B\"),\n            months= d3.timeMonth.range(d3.timeMonth.floor(minDate), maxDate);\n\n        let svg = d3.select(calendarHeatmap.current).selectAll(\"svg\")\n            .data(months)\n            .enter().append(\"svg\")\n            .attr(\"class\", \"month\")\n            .attr(\"height\", ((cellSize * 7) + (cellMargin * 8) + 20) ) // the 20 is for the month labels\n            .attr(\"width\", function(d) {\n                let columns = weeksInMonth(d);\n                return ((cellSize * columns) + (cellMargin * (columns + 1)));\n            })\n            .append(\"g\")\n\n        svg.append(\"text\")\n            .attr(\"class\", \"month-name\")\n            .attr(\"y\", (cellSize * 7) + (cellMargin * 8) + 15 )\n            .attr(\"x\", function(d) {\n                var columns = weeksInMonth(d);\n                return (((cellSize * columns) + (cellMargin * (columns + 1))) / 2);\n            })\n            .attr(\"text-anchor\", \"middle\")\n            .text(function(d) { return monthName(d); })\n\n        let div = d3.select(\"body\").append(\"div\").attr(\"class\", \"toolTip\");\n\n        let rect = svg.selectAll(\"rect.day\")\n            .data(function(d, i) { return d3.timeDays(d, new Date(d.getFullYear(), d.getMonth()+1, 1)); })\n            .enter().append(\"rect\")\n            .attr(\"class\", \"day\")\n            .attr(\"width\", cellSize)\n            .attr(\"height\", cellSize)\n            .attr(\"rx\", 3).attr(\"ry\", 3) // rounded corners\n            .attr(\"fill\", '#eaeaea') // default light grey fill\n            .attr(\"y\", function(d) { return (day(d) * cellSize) + (day(d) * cellMargin) + cellMargin; })\n            .attr(\"x\", function(d) { return ((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellSize) + ((week(d) - week(new Date(d.getFullYear(),d.getMonth(),1))) * cellMargin) + cellMargin ; })\n\n\n        const lookup = new Map(streamingData.map(function (entry){\n                return [entry.date, [entry.msPlayed, entry.artists]]\n            })\n        );\n\n        rect\n            .on(\"mouseover\", function(event, d) {\n                let msTime = 0\n                if (lookup.has(d))\n                    msTime = lookup.get(d)[0]\n                d3.select(this).classed('hover', true);\n                div.style(\"left\", event.pageX+10+\"px\");\n                div.style(\"top\", event.pageY-25+\"px\");\n                div.style(\"display\", \"inline-block\");\n                div.html((d)+\"<br>\"+(msToTime(msTime)));\n            })\n            .on(\"mouseout\", function(event, d) {\n                d3.select(this).classed('hover', false);\n                div.style(\"display\", \"none\");\n            })\n            .on(\"click\", function(event, d) {\n                if(!d3.select(this).classed(\"selected\")){\n                    d3.selectAll(\".day\").classed(\"selected\", false)\n                    d3.select(this).classed('hover', true);\n                    d3.select(this).classed(\"selected\", true);\n                    if (lookup.has(d))\n                        updateBar(lookup.get(d)[1])\n                } else {\n                    d3.select(this).classed('hover', false);\n                    d3.select(this).classed(\"selected\", false)\n                    updateBar(top20Artists)\n                }\n            })\n            .datum(format);\n\n        rect.append(\"title\")\n            .text(function(d) { return titleFormat(new Date(d)); });\n\n        let scale = d3.scaleSequentialSqrt()\n            .domain(d3.extent(streamingData, function(d) { return parseInt(d.msPlayed); }))\n            .range([0.05, 1]);\n\n        rect.style(\"fill\", function(d) {\n                let color = function(d) {\n                    if (lookup.get(d))\n                        return scale(lookup.get(d)[0]);\n                    else\n                        return scale(0)\n                }\n                return d3.interpolateBlues(color(d));\n            })\n\n    })\n\n\n    return(\n        <div id=\"calendar-heatmap\" ref={calendarHeatmap}>\n        </div>\n    )\n\n}\n\nexport default D3CalendarHeatmap;"]},"metadata":{},"sourceType":"module"}